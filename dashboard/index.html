<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Student Java Learning Analytics Dashboard</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@24,400,1,0" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <style>
      :root{ --bg:#0b1020; --card:#0f1628; --muted:#9aa7bd; --text:#e6edf6; --grid:#22304a; --accent:#60a5fa; --accent2:#f472b6; --success:#10b981; --warning:#f59e0b; --danger:#ef4444; --frustrated:#f87171; }
      html,body{height:100%}
      body{margin:0;background:var(--bg);color:var(--text);font-family:"Inter","Segoe UI",system-ui,Roboto,Helvetica,Arial,sans-serif;-webkit-font-smoothing:antialiased}
      .wrap{max-width:1440px;margin:0 auto;padding:36px}
      header{display:flex;align-items:center;justify-content:space-between;margin-bottom:18px}
      h1{margin:0;font-size:28px;font-weight:800;letter-spacing:.2px}
      .subtitle{margin:6px 0 24px;color:var(--muted);font-size:14px}
      .section-title{margin:28px 0 14px;font-weight:800;letter-spacing:.3px;text-transform:uppercase;color:#c7d2fe;font-size:12px}
      .cards{display:grid;gap:16px;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));margin:12px 0 24px}
      .grid{display:grid;gap:20px;grid-template-columns:repeat(auto-fit,minmax(380px,1fr))}
      .card{background:var(--card);border-radius:16px;padding:20px;border:1px solid #1f2a44;box-shadow:0 8px 30px rgba(0,0,0,.28)}
      .kpi{display:flex;flex-direction:column;position:relative;overflow:hidden}
      .kpi::before{content:"";position:absolute;inset:0 0 auto 0;height:4px;background:linear-gradient(90deg,#60a5fa,#a78bfa,#f472b6);opacity:.9}
      .kpi h3{margin:8px 0 6px;color:var(--muted);font-size:12px;font-weight:700;letter-spacing:.06em;text-transform:uppercase}
      .kpi .v{font-size:30px;font-weight:800}
      .learning-outcome-card{border-left:4px solid var(--accent);position:relative}
      .learning-outcome-card.success{border-left-color:var(--success)}
      .learning-outcome-card.warning{border-left-color:var(--warning)}
      .learning-outcome-card.danger{border-left-color:var(--danger)}
      .learning-outcome-card.frustrated{border-left-color:var(--frustrated)}
      .outcome-explanation{font-size:12px;color:var(--muted);margin-top:8px;line-height:1.4}
      .panel{margin-bottom:22px}
      .panel .panel-head{display:flex;align-items:baseline;gap:10px;margin:0 0 10px}
      .panel .panel-title{font-weight:800;letter-spacing:.3px}
      .panel .panel-sub{color:var(--muted);font-size:12px}
      .exit-code-legend{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:12px;margin:16px 0;font-size:12px}
      .legend-item{display:flex;align-items:center;gap:8px}
      .legend-color{width:12px;height:12px;border-radius:3px;flex-shrink:0}
      .legend-item.success .legend-color{background:var(--success)}
      .legend-item.frustrated .legend-color{background:var(--frustrated)}
      .legend-item.crashed .legend-color{background:var(--danger)}
      .legend-item.killed .legend-color{background:var(--warning)}
      .list{display:flex;flex-direction:column;gap:10px}
      .row{display:flex;align-items:center;gap:12px;background:#0b1324;border:1px solid #1f2a44;border-radius:12px;padding:10px 12px}
      .row .icon{font-family:'Material Symbols Rounded', sans-serif; font-variation-settings:'FILL' 1,'wght' 400,'GRAD' 0,'opsz' 24; font-size:18px; width:24px; height:24px; display:grid; place-items:center; border-radius:8px}
      .row.success .icon{background:rgba(16,185,129,.15);color:var(--success)}
      .row.frustrated .icon{background:rgba(248,113,113,.15);color:var(--frustrated)}
      .row .meta{display:flex;gap:12px;color:#b6c3db;font-size:12px}
      .row .title{font-weight:700}
      footer{margin-top:22px;color:var(--muted);font-size:12px}
      canvas{width:100%}
    </style>
  </head>
  <body>
    <div class="wrap">
      <header>
        <div>
          <h1>Student Java Learning Analytics Dashboard</h1>
          <p class="subtitle">Last <span id="windowDays">7</span> days • Tracking student programming sessions • Auto‑updates every 15s</p>
        </div>
        <div class="subtitle" id="meta">–</div>
      </header>

      <h2 class="section-title">Student Learning Outcomes</h2>
      <div class="cards">
        <div class="card kpi learning-outcome-card success" id="kpi-success-card">
          <h3>Successful Sessions</h3>
          <div class="v" id="kpi-success-rate">0%</div>
          <div class="outcome-explanation">Students completed programs normally (Exit Code 0)</div>
        </div>
        <div class="card kpi learning-outcome-card frustrated" id="kpi-frustrated-card">
          <h3>Frustrated Abandonment</h3>
          <div class="v" id="kpi-frustrated-rate">0%</div>
          <div class="outcome-explanation">Students pressed Ctrl+C to quit (Exit Code 130)</div>
        </div>
        <div class="card kpi learning-outcome-card danger" id="kpi-crashed-card">
          <h3>Runtime Errors</h3>
          <div class="v" id="kpi-crashed-rate">0%</div>
          <div class="outcome-explanation">Student code had unhandled exceptions (Exit Code 1)</div>
        </div>
        <div class="card kpi learning-outcome-card warning" id="kpi-killed-card">
          <h3>Process Terminated</h3>
          <div class="v" id="kpi-killed-rate">0%</div>
          <div class="outcome-explanation">Programs killed by system/IDE (Exit Code 143)</div>
        </div>
      </div>

      <h2 class="section-title">Overall Student Activity</h2>
      <div class="cards">
        <div class="card kpi"><h3>Total Sessions</h3><div class="v" id="kpi-total">0</div></div>
        <div class="card kpi"><h3>Unique Students</h3><div class="v" id="kpi-uniques">0</div></div>
        <div class="card kpi"><h3>Programs Started</h3><div class="v" id="kpi-started">0</div></div>
        <div class="card kpi"><h3>Programs Completed</h3><div class="v" id="kpi-completed">0</div></div>
        <div class="card kpi"><h3>Median Duration</h3><div class="v" id="kpi-med">0 ms</div></div>
        <div class="card kpi"><h3>Interactive Sessions</h3><div class="v" id="kpi-interactive">0%</div></div>
      </div>

      <div class="card panel">
        <div class="panel-head">
          <div class="panel-title">Daily Student Learning Outcomes</div>
          <div class="panel-sub">How students are progressing over time</div>
        </div>
  <canvas id="learningOutcomesChart" height="170"></canvas>
  <p class="outcome-explanation">Daily counts of session outcomes derived from database-stored exit codes.</p>
      </div>

      <h2 class="section-title">Session Exit Analysis</h2>
      <div class="card panel">
        <div class="panel-head">
          <div class="panel-title">Student Session Completion Types</div>
          <div class="panel-sub">Understanding how programming sessions end</div>
        </div>
        <div class="exit-code-legend">
          <div class="legend-item success"><div class="legend-color"></div><div><strong>Normal Exit (0)</strong> - Student selected "Exit" option</div></div>
          <div class="legend-item frustrated"><div class="legend-color"></div><div><strong>Ctrl+C (130)</strong> - Student got frustrated and quit</div></div>
          <div class="legend-item crashed"><div class="legend-color"></div><div><strong>Runtime Error (1)</strong> - Unhandled exception in student code</div></div>
          <div class="legend-item killed"><div class="legend-color"></div><div><strong>Terminated (143)</strong> - Killed by system/IDE</div></div>
        </div>
        <div style="max-width:520px;margin:auto">
          <canvas id="exitCodesChart" height="120"></canvas>
        </div>
        <p class="outcome-explanation">This chart shows how student sessions ended based on exit codes. Aim for a higher share of Normal Exit (0).</p>
      </div>

      <h2 class="section-title">Ranked Sessions</h2>
      <div class="grid">
        <div class="card panel">
          <div class="panel-head"><div class="panel-title">Top Successful Learning Sessions</div><div class="panel-sub">Interactive and longer practice time rank higher</div></div>
          <div class="list" id="list-success"></div>
        </div>
        <div class="card panel">
          <div class="panel-head"><div class="panel-title">Frustrated Abandonment Sessions</div><div class="panel-sub">Shortest, non‑interactive quits rank higher</div></div>
          <div class="list" id="list-frustrated"></div>
        </div>
      </div>

      <h2 class="section-title">Student Error Analysis</h2>
      <div class="grid">
        <div class="card panel">
          <div class="panel-head"><div class="panel-title">Student Java Runtime Errors</div><div class="panel-sub">Common programming mistakes students make</div></div>
          <canvas id="studentErrorsChart" height="150"></canvas>
          <p class="outcome-explanation">Compile vs runtime errors help identify where students struggle: setup vs logic.</p>
        </div>
        <div class="card panel">
          <div class="panel-head"><div class="panel-title">Top Student Runtime Exceptions</div><div class="panel-sub">Most frequent errors in student code</div></div>
          <canvas id="topStudentExChart" height="140"></canvas>
          <p class="outcome-explanation">Focus lessons on the most common exceptions first.</p>
        </div>
      </div>

      <h2 class="section-title">Learning Environment</h2>
      <div class="card panel">
        <div class="panel-head"><div class="panel-title">Operating Systems</div><div class="panel-sub">What platforms students are using</div></div>
  <canvas id="osSeriesChart" height="170"></canvas>
  <p class="outcome-explanation">OS trends can explain environment-specific issues.</p>
      </div>

      <h2 class="section-title">Usage Patterns</h2>
      <div class="grid">
        <div class="card panel">
          <div class="panel-head"><div class="panel-title">Programming Activity by Hour</div><div class="panel-sub">When students are most active (UTC)</div></div>
          <canvas id="hourlyHvChart" height="170"></canvas>
          <p class="outcome-explanation">Peak hours can guide when to offer support.</p>
        </div>
        <div class="card panel">
          <div class="panel-head"><div class="panel-title">Day of Week Activity</div><div class="panel-sub">Student programming patterns</div></div>
          <canvas id="dowChart" height="140"></canvas>
          <p class="outcome-explanation">Weekly patterns reflect assignment schedules and labs.</p>
        </div>
      </div>

      <h2 class="section-title">Technical Details</h2>
      <div class="grid">
        <div class="card panel">
          <div class="panel-head"><div class="panel-title">Session Duration Distribution</div><div class="panel-sub">How long students spend programming</div></div>
          <canvas id="durHistChart" height="140"></canvas>
          <p class="outcome-explanation">Longer sessions often indicate deeper practice; very short ones may reflect setup or errors.</p>
        </div>
        <div class="card panel">
          <div class="panel-head"><div class="panel-title">Output Size Distribution</div><div class="panel-sub">Amount of console output generated</div></div>
          <canvas id="outBucketChart" height="140"></canvas>
          <p class="outcome-explanation">Very large outputs can signal infinite loops or excessive logging.</p>
        </div>
        <div class="card panel">
          <div class="panel-head"><div class="panel-title">VS Code Versions</div><div class="panel-sub">Development environment versions</div></div>
          <canvas id="vscodeChart" height="150"></canvas>
          <p class="outcome-explanation">Older versions may lack features or have bugs impacting students.</p>
        </div>
        <div class="card panel">
          <div class="panel-head"><div class="panel-title">Extension Versions</div><div class="panel-sub">Java Web Console extension versions</div></div>
          <canvas id="extChart" height="150"></canvas>
          <p class="outcome-explanation">Ensure students are on the latest extension for the best experience.</p>
        </div>
      </div>

      <footer>
        <p><strong>Privacy Note:</strong> This dashboard tracks anonymous student programming session data to help educators understand learning patterns. No personal information or actual code is collected.</p>
      </footer>
    </div>

    <script>
      const $ = s=>document.querySelector(s);
      const theme = getComputedStyle(document.documentElement);
      const gridColor = theme.getPropertyValue('--grid');
      const axisColor = theme.getPropertyValue('--muted');

      const LEARNING_COLORS = { success:'#10b981', frustrated:'#f87171', crashed:'#ef4444', killed:'#f59e0b' };
      const BASE_COLORS = ['#60a5fa','#22d3ee','#34d399','#f59e0b','#f472b6','#a78bfa','#f87171','#2dd4bf','#fb7185','#c084fc','#fde047','#10b981','#ef4444'];
      const hexToRgba = (hex,a)=>{ const v=hex.replace('#',''); const bigint=parseInt(v,16); const r=(bigint>>16)&255,g=(bigint>>8)&255,b=bigint&255; return `rgba(${r},${g},${b},${a})`; };
      const nfCompact = new Intl.NumberFormat(undefined,{ notation:'compact' });

      function colorSet(n, a=0.75){ const fill=[], stroke=[]; for (let i=0;i<n;i++){ const c=BASE_COLORS[i%BASE_COLORS.length]; stroke.push(c); fill.push(hexToRgba(c,a)); } return { fill, stroke }; }
      const baseScales = (titleY='Count') => ({ x:{ grid:{color:gridColor}, ticks:{color:axisColor} }, y:{ beginAtZero:true, grid:{color:gridColor}, ticks:{color:axisColor, callback:(v)=>nfCompact.format(v)}, title:{display:true, text:titleY, color:axisColor} } });
      const common = { responsive:true, scales: baseScales(), plugins:{ legend:{ labels:{ color:axisColor } }, tooltip:{ backgroundColor:'#0f172a', titleColor:'#e2e8f0', bodyColor:'#cbd5e1', borderColor:'#334155', borderWidth:1 }, title:{ display:false, color:'#d1d5db', font:{ weight:'bold' } } } };
      const withTitle = (cfg, title) => { cfg.options = cfg.options || {}; cfg.options.plugins = cfg.options.plugins || {}; cfg.options.plugins.title = { display:true, text:title, color:'#c7d2fe' }; return cfg; };
      const mkBar = (labels, data, label='Count', title='') => { const cols=colorSet(data.length); const cfg={ type:'bar', data:{ labels, datasets:[{ label, data, backgroundColor:cols.fill, borderColor:cols.stroke, borderWidth:1, borderRadius:6 }] }, options: { ...common, scales: baseScales(label) } }; return title?withTitle(cfg,title):cfg; };
      const mkLine = (labels, data, label, color='#60a5fa', title='') => { const cfg={ type:'line', data:{ labels, datasets:[{ label, data, borderColor: color, backgroundColor: hexToRgba(color,.2), fill:true, tension:.28, pointRadius:2, pointHoverRadius:4 }] }, options: { ...common, scales: baseScales(label) } }; return title?withTitle(cfg,title):cfg; };
      const mkLineMulti = (labels, series, title='') => { const cfg={ type:'line', data:{ labels, datasets: series.map((s,i)=>({ label:s.key, data:s.data, borderColor:BASE_COLORS[i%BASE_COLORS.length], backgroundColor: hexToRgba(BASE_COLORS[i%BASE_COLORS.length], .18), fill:true, tension:.25, pointRadius:1.5 })) }, options: { ...common, scales: baseScales('Hits') } }; return title?withTitle(cfg,title):cfg; };
  const mkDoughnut = (data) => ({ type:'doughnut', data, options:{ responsive:true, maintainAspectRatio:false, cutout:'58%', layout:{ padding:8 }, plugins:{ legend:{ labels:{ color:axisColor } }, tooltip:{ backgroundColor:'#0f172a', titleColor:'#e2e8f0', bodyColor:'#cbd5e1', borderColor:'#334155', borderWidth:1 } } } });

      let charts = {};
      function upsert(id, cfg) { if (!charts[id]) charts[id] = new Chart($(id), cfg); else { charts[id].data = cfg.data; charts[id].options = { ...charts[id].options, ...cfg.options }; charts[id].update(); } }
      function toObjSorted(obj){ const ent = Object.entries(obj||{}).sort((a,b)=>b[1]-a[1]); return { labels: ent.map(e=>e[0]), data: ent.map(e=>e[1]) }; }

      function renderSessions(listId, rows, kind){
        const el = $(listId);
        if (!rows || !rows.length) { el.innerHTML = '<div class="subtitle">No sessions in this category.</div>'; return; }
        el.innerHTML = rows.map(r=>{
          const cls = kind === 'success' ? 'success' : 'frustrated';
          const icon = kind === 'success' ? 'task_alt' : 'sentiment_dissatisfied';
          const mins = Math.round((r.durationMs||0)/60000);
          return `<div class="row ${cls}">
            <div class="icon material-symbols-rounded">${icon}</div>
            <div style="flex:1">
              <div class="title">${r.student}</div>
              <div class="meta">
                <span>${new Date(r.ts).toLocaleString()}</span>
                <span>${mins} min</span>
                <span>${r.interactive? 'Interactive' : 'No input'}</span>
                <span>Exit ${r.exit}</span>
              </div>
            </div>
          </div>`;
        }).join('');
      }

      const mkLearningOutcomes = (labels, successData, frustratedData, crashedData, killedData) => ({
        type:'line',
        data:{ labels, datasets:[
          { label:'Successful Sessions', data:successData, borderColor:LEARNING_COLORS.success, backgroundColor:hexToRgba(LEARNING_COLORS.success,.2), fill:true, tension:.25 },
          { label:'Frustrated (Ctrl+C)', data:frustratedData, borderColor:LEARNING_COLORS.frustrated, backgroundColor:hexToRgba(LEARNING_COLORS.frustrated,.2), fill:true, tension:.25 },
          { label:'Runtime Errors', data:crashedData, borderColor:LEARNING_COLORS.crashed, backgroundColor:hexToRgba(LEARNING_COLORS.crashed,.2), fill:true, tension:.25 },
          { label:'Terminated', data:killedData, borderColor:LEARNING_COLORS.killed, backgroundColor:hexToRgba(LEARNING_COLORS.killed,.2), fill:true, tension:.25 }
        ] },
        options: { ...common, scales: baseScales('Sessions') }
      });

      async function load(){
        const res=await fetch('/stats');
        if(!res.ok){ $('#meta').textContent='Failed to load stats ('+res.status+')'; return; }
        const s=await res.json();
        $('#windowDays').textContent = s.windowDays || 7;
        $('#meta').textContent = `Window: ${s.from} → ${s.to} • Updated ${new Date().toLocaleTimeString()}`;

  const exitCodes = s.exitCodes || {};
  const completedRuns = Number(s.runs?.completed || 0);
  const denom = completedRuns > 0 ? completedRuns : Object.values(exitCodes).reduce((a,b)=>a+Number(b||0),0) || 1;
  const successRate = Math.round(((exitCodes['0'] || 0) / denom) * 100);
  const frustratedRate = Math.round(((exitCodes['130'] || 0) / denom) * 100);
  const crashedRate = Math.round(((exitCodes['1'] || 0) / denom) * 100);
  const killedRate = Math.round(((exitCodes['143'] || 0) / denom) * 100);

        $('#kpi-success-rate').textContent = successRate + '%';
        $('#kpi-frustrated-rate').textContent = frustratedRate + '%';
        $('#kpi-crashed-rate').textContent = crashedRate + '%';
        $('#kpi-killed-rate').textContent = killedRate + '%';

        $('#kpi-total').textContent = (s.total||0).toLocaleString();
        $('#kpi-uniques').textContent = (s.uniques||0).toLocaleString();
        $('#kpi-started').textContent = s.runs?.started||0;
        $('#kpi-completed').textContent = s.runs?.completed||0;
        $('#kpi-med').textContent = Math.round(s.durations?.median||0)+' ms';
        $('#kpi-interactive').textContent = Math.round((s.interactiveRate||0)*100)+'%';

        const dlo = s.dailyLearningOutcomes || {};
        const labels = Object.keys(dlo).sort();
        const successData = labels.map(d => dlo[d]?.['0'] || 0);
        const frustratedData = labels.map(d => dlo[d]?.['130'] || 0);
        const crashedData = labels.map(d => dlo[d]?.['1'] || 0);
        const killedData = labels.map(d => dlo[d]?.['143'] || 0);
        upsert('#learningOutcomesChart', mkLearningOutcomes(labels, successData, frustratedData, crashedData, killedData));

        const doughnutData = { labels:['Normal Exit (0)', 'Ctrl+C Quit (130)', 'Runtime Error (1)', 'Terminated (143)'], datasets:[{ data:[exitCodes['0']||0, exitCodes['130']||0, exitCodes['1']||0, exitCodes['143']||0], backgroundColor:[LEARNING_COLORS.success, LEARNING_COLORS.frustrated, LEARNING_COLORS.crashed, LEARNING_COLORS.killed], borderWidth:2, borderColor:'#1f2a44' }] };
        upsert('#exitCodesChart', mkDoughnut(doughnutData));

        renderSessions('#list-success', s.sessions?.successTop || [], 'success');
        renderSessions('#list-frustrated', s.sessions?.frustratedTop || [], 'frustrated');

        if (s.errors) { const errorData = { labels: ['Compile Errors','Runtime Errors'], data: [s.errors.compile||0, s.errors.runtime||0] }; upsert('#studentErrorsChart', mkBar(errorData.labels, errorData.data, 'Count')); }
        if (s.topExceptions) { const exData = toObjSorted(s.topExceptions); upsert('#topStudentExChart', mkBar(exData.labels, exData.data, 'Occurrences')); }

        if (s.dailyOs) upsert('#osSeriesChart', mkLineMulti(s.dailyOs.labels || [], s.dailyOs.series || [], 'Operating Systems (Daily Hits)'));
        const hours = Array.from({length:24},(_,i)=>i.toString().padStart(2,'0'));
        upsert('#hourlyHvChart', mkLine(hours, s.hourly||[], 'Sessions'));
        const dowL = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];
        upsert('#dowChart', mkBar(dowL, s.dow||[], 'Sessions'));

        if (s.durations?.hist) upsert('#durHistChart', mkBar(s.durations.hist.labels || [], s.durations.hist.values || [], 'Sessions'));
        if (s.outputBuckets) { const outData = toObjSorted(s.outputBuckets); upsert('#outBucketChart', mkBar(outData.labels, outData.data, 'Sessions')); }
        if (s.byVscode) { const vscData = toObjSorted(s.byVscode); upsert('#vscodeChart', mkBar(vscData.labels, vscData.data, 'Users')); }
        if (s.byExt) { const extData = toObjSorted(s.byExt); upsert('#extChart', mkBar(extData.labels, extData.data, 'Users')); }
      }

      load();
      setInterval(load,15000);
    </script>
  </body>
</html>